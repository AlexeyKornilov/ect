/*!
 * ECT CoffeeScript template engine v0.3.1
 * https://github.com/baryshev/ect
 *
 * Copyright 2012, Vadim M. Baryshev <vadimbaryshev@gmail.com>
 * Licensed under the MIT license
 * https://github.com/baryshev/ect/LICENSE
 *
 * Includes parts of node
 * https://github.com/joyent/node
 * Copyright Joyent, Inc. and other Node contributors
 * Released under the MIT license
 *
 * Includes Cross-Browser Split 1.1.1
 * http://xregexp.com/
 * Copyright 2007-2012 Steven Levithan <stevenlevithan.com>
 * Released under the MIT license
 */
(function(){"use strict";var fs,path,CoffeeScript,ECT=function(options){if(!(this instanceof ECT))return new ECT(options);var ect=this;this.options={open:"<%",close:"%>",ext:"",cache:!0,watch:!1,root:""};var trimExp=/^\s+|\s+$/g,newlineExp=/\n/g,cache={},watchers={},indentChars={":":":",">":">"},escapeExp=/&|<|>|"/g,escapedChars={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"},escapeHandler=function(e){return escapedChars[e]},regExpEscape=function(e){return String(e).replace(/([.*+?\^=!:${}()|\[\]\/\\])/g,"\\$1")},parse=function(e){var t=1,n=["__ectOutput"],r=0,i=n[r]+" = '",s=e.split(new RegExp(regExpEscape(ect.options.open)+"((?:.|[\r\n])+?)(?:"+regExpEscape(ect.options.close)+"|$)")),o,u,a,f,l,c,h,p,d="",v=!1,m=[],g=-1,y;for(var b=0;b<s.length;b++){u=s[b],a="";if(b%2===1){f="__ectFileInfo.line = "+t;switch(u.charAt(0)){case"=":l="' + ("+f+"\n'') + __ectTemplateContext.escape(",c=") + '",h="",u=u.substr(1),o=!0;break;case"-":l="' + ("+f+"\n'') + ((",c=") ? '') + '",h="",u=u.substr(1),o=!0;break;default:l="'\n"+f,c="\n"+n[r]+" += '",h="\n",o=!1}u=u.replace(trimExp,""),a=u.split(/[^a-z]+/)[0];if(p=indentChars[u.charAt(u.length-1)])u=u.replace(/:$/,"").replace(trimExp,""),p===">"&&(n.push("__ectFunction"+r),r++,c="\n"+n[r]+" = '",a="function"),m.push(a),g++,v=!0;switch(a){case"include":o||(l="' + ("+f+"\n'') + (",c=") + '"),i+=l.replace(newlineExp,"\n"+d)+u+c.replace(newlineExp,"\n"+d);break;case"block":n.push("__ectTemplateContext.blocks['"+u.replace(/block\s+('|")([^'"]+)('|").*/,"$2")+"']"),r++,l="'\n",c="\n"+n[r]+" += '",u="if "+u,i+=l.replace(newlineExp,"\n"+d)+u,v&&(d+="  ",v=!1),i+=c.replace(newlineExp,"\n"+d);break;case"content":o||(l="' + ("+f+"\n'') + (",c=") + '"),u==="content"&&(u="content()"),i+=l.replace(newlineExp,"\n"+d)+u+c.replace(newlineExp,"\n"+d);break;case"end":l="'";switch(m[g]){case"block":n.pop(),r--,l="'",c="\n"+n[r]+" += '",i+=l.replace(newlineExp,"\n"+d),d=d.substr(2),i+=c.replace(newlineExp,"\n"+d);break;case"when":c="\n"+n[r]+" += ''",i+=l.replace(newlineExp,"\n"+d)+c.replace(newlineExp,"\n"+d),d=d.substr(2);break;case"function":l="'\n"+n[r],i+=l.replace(newlineExp,"\n"+d),d=d.substr(2),n.pop(),r--,c="\n"+n[r]+" += '",i+=c.replace(newlineExp,"\n"+d);break;case"switch":l="\n"+f;default:m[g-1]==="switch"&&(c=""),d=d.substr(2),i+=l.replace(newlineExp,"\n"+d)+c.replace(newlineExp,"\n"+d)}m.pop(),g--;break;case"else":m[g-1]==="switch"?l="":l="'",i+=l.replace(newlineExp,"\n"+d),m[g-1]==="if"&&(m.splice(-2,1),g--,d=d.substr(2)),i+=(h.length?h+d:"")+u,v&&(d+="  ",v=!1),i+=c.replace(newlineExp,"\n"+d);break;case"switch":i+=l.replace(newlineExp,"\n"+d)+(h.length?h+d:"")+u,v&&(d+="  ",v=!1);break;case"when":i+=(h.length?h+d:"")+u,v&&(d+="  ",v=!1),i+=c.replace(newlineExp,"\n"+d);break;case"extend":y=!0,u="__ectParent = "+u.replace(/extend\s+/,"");default:i+=l.replace(newlineExp,"\n"+d)+(h.length?h+d:"")+u,v&&(d+="  ",v=!1),i+=c.replace(newlineExp,"\n"+d)}}else m[g]!=="switch"&&(i+=u.replace(/[\\']/g,"\\$&").replace(/\r/g,"").replace(newlineExp,"\\n"));t+=u.split(newlineExp).length-1}return i+="'\nif not __ectExtended\n  return __ectOutput\nelse\n  __ectContainer = __ectTemplateContext.load __ectParent\n  __ectFileInfo.file = __ectContainer.file\n  __ectFileInfo.line = 1\n  __ectTemplateContext.childContent = __ectOutput\n  return __ectContainer.compiled.call(this, __ectTemplateContext, __ectFileInfo, include, content, block)",i="__ectExtended = "+(y?"true":"false")+"\n"+i,new Function("__ectTemplateContext","__ectFileInfo","include","content","block",CoffeeScript.compile(i,{bare:!0}))},read=function(file){if(Object.prototype.toString.call(ect.options.root)==="[object Object]"){var data=eval("(ect.options.root."+file+")");if(Object.prototype.toString.call(data)==="[object String]")return data;throw new Error("Failed to load template "+file)}try{return fs.readFileSync(file,"utf8")}catch(e){throw new Error("Failed to load template "+e.path)}},TemplateContext=function(e){this.blocks={},this.data=e,this.childContent=""};TemplateContext.prototype.escape=function(e){var t=typeof e;return t==="undefined"?"":t!=="string"?e:e.replace(escapeExp,escapeHandler)},TemplateContext.prototype.block=function(e){return this.blocks[e]||(this.blocks[e]=""),!this.blocks[e].length},TemplateContext.prototype.content=function(e){return e&&e.length?this.blocks[e]?this.blocks[e]:"":this.childContent},TemplateContext.prototype.load=function(e){var t,n,r,i;if(ect.options.cache&&cache[e])return cache[e];Object.prototype.toString.call(ect.options.root)==="[object String]"?t=path.normalize((ect.options.root.length?ect.options.root+"/":"")+e+ect.options.ext):t=e,i=read(t);try{n=parse(i)}catch(s){throw s.message=s.message.replace(/ on line \d+/,"")+" in "+t,s}return r={file:t,compiled:n},ect.options.cache&&(cache[e]=r),ect.options.watch&&(watchers[t]=fs.watch(t,function(){watchers[t].close(),delete watchers[t],delete cache[e]})),r},TemplateContext.prototype.render=function(e,t){var n=this,r=this.load(e),i={file:r.file,line:1};try{return r.compiled.call(t||this.data,this,i,function(){return n.render.apply(n,arguments)},function(){return n.content.apply(n,arguments)},function(){return n.block.apply(n,arguments)})}catch(s){throw s.message=s.message+" in "+i.file+" on line "+i.line,s}},this.configure=function(e){e=e||{};for(var t in e)this.options[t]=e[t]},this.render=function(e,t,n){typeof t=="function"&&(n=t,t={}),n=n||function(){};var r=new TemplateContext(t);try{var i=r.render(e);n(undefined,i)}catch(s){n(s)}},this.configure(options)};if(typeof module!="undefined"&&module.exports)fs=require("fs"),path=require("path"),CoffeeScript=require("coffee-script"),module.exports=ECT;else{Array.prototype.filter||(Array.prototype.filter=function(e,t){var n=this.length,r=[],i,s;if(typeof e!="function")throw new TypeError;for(i=0;i<n;i++)i in this&&(s=this[i],e.call(t,s,i,this)&&r.push(s));return r});var split;split=split||function(e){var t=String.prototype.split,n=/()??/.exec("")[1]===e,r;return r=function(r,i,s){if(Object.prototype.toString.call(i)!=="[object RegExp]")return t.call(r,i,s);var o=[],u=(i.ignoreCase?"i":"")+(i.multiline?"m":"")+(i.extended?"x":"")+(i.sticky?"y":""),a=0,i=new RegExp(i.source,u+"g"),f,l,c,h;r+="",n||(f=new RegExp("^"+i.source+"$(?!\\s)",u)),s=s===e?-1>>>0:s>>>0;while(l=i.exec(r)){c=l.index+l[0].length;if(c>a){o.push(r.slice(a,l.index)),!n&&l.length>1&&l[0].replace(f,function(){for(var t=1;t<arguments.length-2;t++)arguments[t]===e&&(l[t]=e)}),l.length>1&&l.index<r.length&&Array.prototype.push.apply(o,l.slice(1)),h=l[0].length,a=c;if(o.length>=s)break}i.lastIndex===l.index&&i.lastIndex++}return a===r.length?(h||!i.test(""))&&o.push(""):o.push(r.slice(a)),o.length>s?o.slice(0,s):o},String.prototype.split=function(e,t){return r(this,e,t)},r}(),window.ECT=ECT,CoffeeScript=window.CoffeeScript,path=function(){var e=function(e,t){var n=0,r,i;for(r=e.length-1;r>=0;r--)i=e[r],i==="."?e.splice(r,1):i===".."?(e.splice(r,1),n++):n&&(e.splice(r,1),n--);if(t)while(n)e.unshift(".."),n--;return e},t=function(t){var n=t.charAt(0)==="/",r=t.slice(-1)==="/";return t=e(t.split("/").filter(function(e){return!!e}),!n).join("/"),!t&&!n&&(t="."),t&&r&&(t+="/"),(n?"/":"")+t};return{normalize:t}}(),fs=function(){var e=function(e,t){var n;window.XMLHttpRequest?(n=new XMLHttpRequest,n.overrideMimeType&&n.overrideMimeType("text/html")):n=new ActiveXObject("Microsoft.XMLHTTP");if(n){n.open("GET",e,!1),n.send(null);if(n.status<200||n.status>399)throw new Error("Failed to load template "+e);return n.responseText}throw new Error("Failed to load template "+e)},t=function(){};return{readFileSync:e,watch:t}}()}})();