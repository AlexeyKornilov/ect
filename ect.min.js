/*!
 * ECT CoffeeScript template engine v0.4.6
 * https://github.com/baryshev/ect
 *
 * Copyright 2012, Vadim M. Baryshev <vadimbaryshev@gmail.com>
 * Licensed under the MIT license
 * https://github.com/baryshev/ect/LICENSE
 *
 * Includes parts of node
 * https://github.com/joyent/node
 * Copyright Joyent, Inc. and other Node contributors
 * Released under the MIT license
 *
 * Includes Cross-Browser Split 1.1.1
 * http://xregexp.com/
 * Copyright 2007-2012 Steven Levithan <stevenlevithan.com>
 * Released under the MIT license
 */
(function(){"use strict";var fs,path,CoffeeScript,ECT=function(options){if(!(this instanceof ECT))return new ECT(options);var ect=this;this.options={open:"<%",close:"%>",ext:"",cache:!0,watch:!1,root:""};var trimExp=/^[ \t]+|[ \t]+$/g,newlineExp=/\n/g,cache={},watchers={},indentChars={":":":",">":">"},escapeExp=/[&<>"]/,escapeAmpExp=/&/g,escapeLtExp=/</g,escapeGtExp=/>/g,escapeQuotExp=/"/g,regExpEscape=function(e){return String(e).replace(/([.*+?\^=!:${}()|\[\]\/\\])/g,"\\$1")},parse=function(template){var lineNo=1,bufferStack=["__ectOutput"],bufferStackPointer=0,buffer=bufferStack[bufferStackPointer]+" = '",matches=template.split(new RegExp(regExpEscape(ect.options.open)+"((?:.|[\r\n])+?)(?:"+regExpEscape(ect.options.close)+"|$)")),output,text,command,line,prefix,postfix,newline,indentChar,indentation="",indent=!1,indentStack=[],indentStackPointer=-1,baseIndent,lines,j;for(var i=0;i<matches.length;i++){text=matches[i],command="";if(i%2===1){line="__ectFileInfo.line = "+lineNo;switch(text.charAt(0)){case"=":prefix="' + ("+line+"\n'') + __ectTemplateContext.escape(",postfix=") + '",newline="",text=text.substr(1),output="escaped";break;case"-":prefix="' + ("+line+"\n'') + ((",postfix=") ? '') + '",newline="",text=text.substr(1),output="unescaped";break;default:prefix="'\n"+line,postfix="\n"+bufferStack[bufferStackPointer]+" += '",newline="\n",output="none"}text=text.replace(trimExp,""),command=text.split(/[^a-z]+/)[0];if(indentChar=indentChars[text.charAt(text.length-1)])text=text.replace(/:$/,"").replace(trimExp,""),indentChar===">"&&(/[$a-z_][0-9a-z_$]*[^=]+(-|=)>/i.test(text.replace(/'.*'|".*"/,""))&&(indentStack.push("capture_output_"+output),indentStackPointer++),bufferStack.push("__ectFunction"+bufferStackPointer),bufferStackPointer++,postfix="\n"+bufferStack[bufferStackPointer]+" = '",command="function"),indentStack.push(command),indentStackPointer++,indent=!0;switch(command){case"include":output==="none"&&(prefix="' + ("+line+"\n'') + (",postfix=") + '"),buffer+=prefix.replace(newlineExp,"\n"+indentation)+text+postfix.replace(newlineExp,"\n"+indentation);break;case"block":bufferStack.push("__ectTemplateContext.blocks['"+text.replace(/block\s+('|")([^'"]+)('|").*/,"$2")+"']"),bufferStackPointer++,prefix="'\n",postfix="\n"+bufferStack[bufferStackPointer]+" += '",text="if "+text,buffer+=prefix.replace(newlineExp,"\n"+indentation)+text,indent&&(indentation+="  ",indent=!1),buffer+=postfix.replace(newlineExp,"\n"+indentation);break;case"content":output==="none"&&(prefix="' + ("+line+"\n'') + (",postfix=") + '"),text==="content"&&(text="content()"),buffer+=prefix.replace(newlineExp,"\n"+indentation)+text+postfix.replace(newlineExp,"\n"+indentation);break;case"end":prefix="'";switch(indentStack[indentStackPointer]){case"block":bufferStack.pop(),bufferStackPointer--,prefix="'",postfix="\n"+bufferStack[bufferStackPointer]+" += '",buffer+=prefix.replace(newlineExp,"\n"+indentation),indentation=indentation.substr(2),buffer+=postfix.replace(newlineExp,"\n"+indentation);break;case"when":postfix="\n"+bufferStack[bufferStackPointer]+" += ''",buffer+=prefix.replace(newlineExp,"\n"+indentation)+postfix.replace(newlineExp,"\n"+indentation),indentation=indentation.substr(2);break;case"function":prefix="'\n"+bufferStack[bufferStackPointer],buffer+=prefix.replace(newlineExp,"\n"+indentation),indentation=indentation.substr(2),bufferStack.pop(),bufferStackPointer--,postfix="\n"+bufferStack[bufferStackPointer]+" += '";switch(indentStack[indentStackPointer-1]){case"capture_output_escaped":indentStack.pop(),indentStackPointer--,buffer+=")";break;case"capture_output_unescaped":indentStack.pop(),indentStackPointer--,buffer+=") ? '')";break;case"capture_output_none":indentStack.pop(),indentStackPointer--}buffer+=postfix.replace(newlineExp,"\n"+indentation);break;case"switch":prefix="\n"+line;default:indentStack[indentStackPointer-1]==="switch"&&(postfix=""),indentation=indentation.substr(2),buffer+=prefix.replace(newlineExp,"\n"+indentation)+postfix.replace(newlineExp,"\n"+indentation)}indentStack.pop(),indentStackPointer--;break;case"else":indentStack[indentStackPointer-1]==="switch"?prefix="":prefix="'",buffer+=prefix.replace(newlineExp,"\n"+indentation);if(indentStack[indentStackPointer-1]==="if"||indentStack[indentStackPointer-1]==="else")indentStack.splice(-2,1),indentStackPointer--,indentation=indentation.substr(2);buffer+=(newline.length?newline+indentation:"")+text,indent&&(indentation+="  ",indent=!1),buffer+=postfix.replace(newlineExp,"\n"+indentation);break;case"switch":buffer+=prefix.replace(newlineExp,"\n"+indentation)+(newline.length?newline+indentation:"")+text,indent&&(indentation+="  ",indent=!1);break;case"when":buffer+=(newline.length?newline+indentation:"")+text,indent&&(indentation+="  ",indent=!1),buffer+=postfix.replace(newlineExp,"\n"+indentation);break;case"extend":text="__ectExtended = true\n__ectParent = "+text.replace(/extend\s+/,"");default:if(/\n/.test(text)){lines=text.split(/\n/),buffer+=prefix.replace(newlineExp,"\n"+indentation);for(j=0;j<lines.length;j++){if(/^\s*$/.test(lines[j]))continue;typeof baseIndent=="undefined"&&(baseIndent=new RegExp("^"+lines[j].substr(0,lines[j].search(/[^\s]/)))),buffer+=(newline.length?newline+indentation:"")+lines[j].replace(baseIndent,"")}lines=undefined,baseIndent=undefined}else buffer+=prefix.replace(newlineExp,"\n"+indentation)+(newline.length?newline+indentation:"")+text;indent&&(indentation+="  ",indent=!1),buffer+=postfix.replace(newlineExp,"\n"+indentation)}}else indentStack[indentStackPointer]!=="switch"&&(buffer+=text.replace(/[\\']/g,"\\$&").replace(/\r/g,"").replace(newlineExp,"\\n").replace(/^\\n/,""));lineNo+=text.split(newlineExp).length-1}return buffer+="'\nif not __ectExtended\n  return __ectOutput\nelse\n  __ectContainer = __ectTemplateContext.load __ectParent\n  __ectFileInfo.file = __ectContainer.file\n  __ectFileInfo.line = 1\n  __ectTemplateContext.childContent = __ectOutput\n  return __ectContainer.compiled.call(this, __ectTemplateContext, __ectFileInfo, include, content, block)",buffer="__ectExtended = false\n"+buffer,eval("(function __ectTemplate(__ectTemplateContext, __ectFileInfo, include, content, block) {\n"+CoffeeScript.compile(buffer,{bare:!0})+"});")},read=function(file){if(Object.prototype.toString.call(ect.options.root)==="[object Object]"){var data=eval("(ect.options.root."+file+")");if(Object.prototype.toString.call(data)==="[object String]")return data;throw new Error("Failed to load template "+file)}try{return fs.readFileSync(file,"utf8")}catch(e){throw new Error("Failed to load template "+file)}},TemplateContext=function(e){this.blocks={},this.data=e||{},this.childContent=""};TemplateContext.prototype.escape=function(e){if(e==null)return"";var t=e.toString();return escapeExp.test(t)?t.replace(escapeAmpExp,"&#38;").replace(escapeLtExp,"&#60;").replace(escapeGtExp,"&#62;").replace(escapeQuotExp,"&#34;"):t},TemplateContext.prototype.block=function(e){return this.blocks[e]||(this.blocks[e]=""),!this.blocks[e].length},TemplateContext.prototype.content=function(e){return e&&e.length?this.blocks[e]?this.blocks[e]:"":this.childContent},TemplateContext.prototype.load=function(template){var file,compiled,container,data;if(ect.options.cache&&cache[template])return cache[template];var extExp=new RegExp(ect.options.ext+"$");Object.prototype.toString.call(ect.options.root)==="[object String]"?typeof process!="undefined"&&process.platform==="win32"?file=path.normalize((ect.options.root.length&&template.charAt(0)!=="/"&&template.charAt(0)!=="\\"&&!/^[a-zA-Z]:/.test(template)?ect.options.root+"/":"")+template.replace(extExp,"")+ect.options.ext):file=path.normalize((ect.options.root.length&&template.charAt(0)!=="/"?ect.options.root+"/":"")+template.replace(extExp,"")+ect.options.ext):file=template,data=read(file);if(data.substr(0,24)==="(function __ectTemplate(")try{compiled=eval(data)}catch(e){throw e.message=e.message+" in "+file,e}else try{compiled=parse(data)}catch(e){throw e.message=e.message.replace(/ on line \d+/,"")+" in "+file,e}return container={file:file,compiled:compiled,source:compiled.toString(),gzip:null},ect.options.cache&&(cache[template]=container),ect.options.watch&&(watchers[file]=fs.watch(file,function(){watchers[file].close(),delete watchers[file],delete cache[template]})),container},TemplateContext.prototype.render=function(e,t){var n=this,r=this.load(e),i={file:r.file,line:1};try{return r.compiled.call(t||this.data,this,i,function(){return n.render.apply(n,arguments)},function(){return n.content.apply(n,arguments)},function(){return n.block.apply(n,arguments)})}catch(s){throw/ in /.test(s.message)||(s.message=s.message+" in "+i.file+" on line "+i.line),s}},this.configure=function(e){e=e||{};for(var t in e)this.options[t]=e[t]},this.render=function(e,t,n){var r=new TemplateContext(t);return r.render(e)},this.render=function(e,t,n){var r;if(typeof arguments[arguments.length-1]!="function")return r=new TemplateContext(t),r.render(e);arguments.length===2&&(n=t,t={}),r=new TemplateContext(t);try{n(undefined,r.render(e))}catch(i){n(i)}},typeof module!="undefined"&&module.exports&&(this.compiler=function(e){var t=require("zlib");e=e||{},e.root=e.root||"/",e.root="/"+e.root.replace(/^\//,""),e.root=e.root.replace(/\/$/,"")+"/";var n=new RegExp("^"+e.root);return function(r,i,s){if(r.url.substr(0,e.root.length)===e.root){var o=r.url.replace(n,"");try{var u=new TemplateContext,a=u.load(o);i.setHeader("Content-Type","application/x-javascript; charset=utf-8"),e.gzip?(i.setHeader("Content-Encoding","gzip"),a.gzip===null?t.gzip(a.source,function(e,t){e?s(e):(a.gzip=t,i.end(a.gzip))}):i.end(a.gzip)):i.end(a.source)}catch(f){s(f)}}else s()}}),this.configure(options)};if(typeof module!="undefined"&&module.exports)fs=require("fs"),path=require("path"),CoffeeScript=require("coffee-script"),module.exports=ECT;else{Array.prototype.filter||(Array.prototype.filter=function(e,t){var n=this.length,r=[],i,s;if(typeof e!="function")throw new TypeError;for(i=0;i<n;i++)i in this&&(s=this[i],e.call(t,s,i,this)&&r.push(s));return r});var split;split=split||function(e){var t=String.prototype.split,n=/()??/.exec("")[1]===e,r;return r=function(r,i,s){if(Object.prototype.toString.call(i)!=="[object RegExp]")return t.call(r,i,s);var o=[],u=(i.ignoreCase?"i":"")+(i.multiline?"m":"")+(i.extended?"x":"")+(i.sticky?"y":""),a=0,i=new RegExp(i.source,u+"g"),f,l,c,h;r+="",n||(f=new RegExp("^"+i.source+"$(?!\\s)",u)),s=s===e?-1>>>0:s>>>0;while(l=i.exec(r)){c=l.index+l[0].length;if(c>a){o.push(r.slice(a,l.index)),!n&&l.length>1&&l[0].replace(f,function(){for(var t=1;t<arguments.length-2;t++)arguments[t]===e&&(l[t]=e)}),l.length>1&&l.index<r.length&&Array.prototype.push.apply(o,l.slice(1)),h=l[0].length,a=c;if(o.length>=s)break}i.lastIndex===l.index&&i.lastIndex++}return a===r.length?(h||!i.test(""))&&o.push(""):o.push(r.slice(a)),o.length>s?o.slice(0,s):o},String.prototype.split=function(e,t){return r(this,e,t)},r}(),window.ECT=ECT,CoffeeScript=window.CoffeeScript,path=function(){var e=function(e,t){var n=0,r,i;for(r=e.length-1;r>=0;r--)i=e[r],i==="."?e.splice(r,1):i===".."?(e.splice(r,1),n++):n&&(e.splice(r,1),n--);if(t)while(n)e.unshift(".."),n--;return e},t=function(t){var n=t.charAt(0)==="/",r=t.slice(-1)==="/";return t=e(t.split("/").filter(function(e){return!!e}),!n).join("/"),!t&&!n&&(t="."),t&&r&&(t+="/"),(n?"/":"")+t};return{normalize:t}}(),fs=function(){var e=function(e,t){var n;window.XMLHttpRequest?(n=new XMLHttpRequest,n.overrideMimeType&&n.overrideMimeType("text/html")):n=new ActiveXObject("Microsoft.XMLHTTP");if(n){n.open("GET",e,!1),n.send(null);if(n.status!==0&&(n.status<200||n.status>399))throw new Error("Failed to load template "+e);return n.responseText}throw new Error("Failed to load template "+e)},t=function(){};return{readFileSync:e,watch:t}}()}})();