/*!
 * ECT CoffeeScript template engine v0.2.5
 * https://github.com/baryshev/ect
 *
 * Copyright 2012, Vadim M. Baryshev <vadimbaryshev@gmail.com>
 * Licensed under the MIT license
 * https://github.com/baryshev/ect/LICENSE
 *
 * Includes parts of node
 * https://github.com/joyent/node
 * Copyright Joyent, Inc. and other Node contributors
 * Released under the MIT license
 *
 * Includes Cross-Browser Split 1.0.1
 * http://xregexp.com/
 * Copyright Steven Levithan <stevenlevithan.com>
 * Released under the MIT license
 */
(function(){"use strict";var fs,path,CoffeeScript,ECT=function(options){if(!(this instanceof ECT))return new ECT(options);var ect=this;this.options={open:"<%",close:"%>",ext:"",cache:!1,watch:!1,root:""};var trimExp=/^\s+|\s+$/g,newlineExp=/\n/g,paramExp=/(partial|extend|block)\s+('|")([^'"]+)('|")/,cache={},loaders={},watchers={},indentChars={":":":",">":">"},regExpEscape=function(e){return String(e).replace(/([.*+?\^=!:${}()|\[\]\/\\])/g,"\\$1")},iterate=function(e,t,n){if(!e.length)return n();var r=0;for(var i=0;i<e.length;i++)t(e[i],function(t){t?(n(t),n=function(){}):(r++,r===e.length&&n())})},parse=function(e,t){var n=1,r=["__ectOutput"],i=0,s="__ectExtend = undefined\n"+r[i]+" = '",o=e.split(new RegExp(regExpEscape(ect.options.open)+"((?:.|[\r\n])+?)(?:"+regExpEscape(ect.options.close)+"|$)")),u,a,f,l=[],c,h,p,d,v="",m=!1,g=[],y=-1,b;for(var w=0;w<o.length;w++){u=o[w],a="";if(w%2===1){f="__ectFileInfo.line = "+n;switch(u.charAt(0)){case"=":c="' + __ectTemplateContext.empty("+f+") + __ectTemplateContext.escape(",h=") + '",p="",u=u.substr(1);break;case"-":c="' + __ectTemplateContext.empty("+f+") + (",h=") + '",p="",u=u.substr(1);break;default:c="'\n"+f,h="\n"+r[i]+" += '",p="\n"}u=u.replace(trimExp,""),a=u.split(/[^a-z]+/)[0];if(d=indentChars[u.charAt(u.length-1)])u=u.replace(/:$/,"").replace(trimExp,""),d===">"&&(r.push("__ectFunction"+i),i++,h="\n"+r[i]+" = '",a="function"),g.push(a),y++,m=!0;switch(a){case"partial":l.push(u.replace(paramExp,"$3")),c="' + __ectTemplateContext.empty("+f+") + (",h=") + '",s+=c.replace(newlineExp,"\n"+v)+u+h.replace(newlineExp,"\n"+v);break;case"block":r.push("__ectTemplateContext.blocks['"+u.replace(paramExp,"$3")+"']"),i++,c="'\n",h="\n"+r[i]+" += '",u="if "+u,s+=c.replace(newlineExp,"\n"+v)+u,m&&(v+="  ",m=!1),s+=h.replace(newlineExp,"\n"+v);break;case"content":c="' + __ectTemplateContext.empty("+f+") + (",h=") + '",u==="content"&&(u="if __ectChildContent then __ectChildContent else ''"),s+=c.replace(newlineExp,"\n"+v)+u+h.replace(newlineExp,"\n"+v);break;case"end":c="'";switch(g[y]){case"block":r.pop(),i--,c="'",h="\n"+r[i]+" += '",s+=c.replace(newlineExp,"\n"+v),v=v.substr(2),s+=h.replace(newlineExp,"\n"+v);break;case"when":h="\n"+r[i]+" += ''",s+=c.replace(newlineExp,"\n"+v)+h.replace(newlineExp,"\n"+v),v=v.substr(2);break;case"function":c="'\n"+r[i],s+=c.replace(newlineExp,"\n"+v),v=v.substr(2),r.pop(),i--,h="\n"+r[i]+" += '",s+=h.replace(newlineExp,"\n"+v);break;case"switch":c="\n"+f,v=v.substr(2);default:g[y-1]==="switch"&&(h=""),v=v.substr(2),s+=c.replace(newlineExp,"\n"+v)+h.replace(newlineExp,"\n"+v)}g.pop(),y--;break;case"else":g[y-1]==="switch"?c="":c="'",s+=c.replace(newlineExp,"\n"+v),g[y-1]==="if"&&(g.splice(-2,1),y--,v=v.substr(2)),s+=(p.length?p+v:"")+u,m&&(v+="  ",m=!1),s+=h.replace(newlineExp,"\n"+v);break;case"switch":s+=c.replace(newlineExp,"\n"+v)+(p.length?p+v:"")+u,m&&(v+="  ",m=!1);break;case"when":s+=(p.length?p+v:"")+u,m&&(v+="  ",m=!1),s+=h.replace(newlineExp,"\n"+v);break;case"extend":b=u.replace(paramExp,"$3"),l.push(b),c="'",h="\n"+r[i]+" += '",u="__ectExtend = '"+b+"'",s+=c.replace(newlineExp,"\n"+v)+(p.length?p+v:"")+u+h.replace(newlineExp,"\n"+v);break;default:s+=c.replace(newlineExp,"\n"+v)+(p.length?p+v:"")+u,m&&(v+="  ",m=!1),s+=h.replace(newlineExp,"\n"+v)}}else g[y]!=="switch"&&(s+=u.replace(/[\\']/g,"\\$&").replace(/\r/g,"").replace(newlineExp,"\\n"));n+=u.split(newlineExp).length-1}s+="'\nif not __ectExtend\n  return __ectOutput\nelse\n  __ectFileInfo.file = __ectTemplateContext.compiled['"+b+"'].file\n  __ectFileInfo.line = 1\n  return __ectTemplateContext.compiled['"+b+"'].compiled.call(this, __ectTemplateContext, __ectFileInfo, partial, content, block, __ectOutput)";try{var E=Function("__ectTemplateContext","__ectFileInfo","partial","content","block","__ectChildContent",CoffeeScript.compile(s,{bare:!0}));t(undefined,E,l)}catch(S){t(S)}},loaded=function(e,t){var n=loaders[t];delete loaders[t];for(var r=0;r<n.length;r++)n[r](e)},read=function(file,callback){if(Object.prototype.toString.call(ect.options.root)==="[object Object]")try{var data=eval("(options.root."+file+")");Object.prototype.toString.call(data)==="[object String]"?callback(undefined,data):callback(new Error("Failed to load template "+file))}catch(e){callback(e)}else fs.readFile(file,"utf8",function(e,t){e&&(e=new Error("Failed to load template "+e.path)),callback(e,t)})},TemplateContext=function(e){this.compiled={},this.blocks={},this.data={};if(e)for(var t in e)this.data[t]=e[t]};TemplateContext.prototype.escape=function(e){var t=typeof e;return t==="undefined"?"":t!=="string"?e:e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},TemplateContext.prototype.empty=function(){return""},TemplateContext.prototype.block=function(e){return this.blocks[e]||(this.blocks[e]=""),!this.blocks[e].length},TemplateContext.prototype.partial=function(e,t){return this.render(e,t)},TemplateContext.prototype.content=function(e){return e&&e.length?this.blocks[e]?this.blocks[e]:"":""},TemplateContext.prototype.load=function(e,t){var n=this,r;this.compiled[e]?iterate(this.compiled[e].dependencies,function(e,t){n.load(e,t)},function(e){t(e)}):ect.options.cache&&cache[e]?(this.compiled[e]=cache[e],iterate(cache[e].dependencies,function(e,t){n.load(e,t)},function(e){t(e)})):loaders[e]?loaders[e].push(t):(loaders[e]=[t],Object.prototype.toString.call(ect.options.root)==="[object String]"?r=path.normalize((ect.options.root.length?ect.options.root+"/":"")+e+ect.options.ext):r=e,read(r,function(t,i){if(t){loaded(t,e);return}parse(i,function(t,i,s){if(t){t.message=t.message.replace(/ on line \d+/,"")+" in "+r,loaded(t,e);return}n.compiled[e]={compiled:i,dependencies:s,file:r},ect.options.cache&&(cache[e]=n.compiled[e]),ect.options.watch&&(watchers[r]=fs.watch(r,function(){watchers[r].close(),delete watchers[r],delete cache[e]})),iterate(s,function(e,t){n.load(e,t)},function(t){loaded(t,e)})})}))},TemplateContext.prototype.render=function(e,t){var n=this,r={};if(this.data)for(var i in this.data)r[i]=this.data[i];if(t)for(var i in t)r[i]=t[i];var s={file:this.compiled[e].file,line:1};try{var o=this.compiled[e].compiled.call(r,this,s,function(){return n.partial.apply(n,arguments)},function(){return n.content.apply(n,arguments)},function(){return n.block.apply(n,arguments)});return o}catch(u){throw u.message=u.message+" in "+s.file+" on line "+s.line,u}},this.configure=function(e){e=e||{};for(var t in e){if(typeof this.options[t]=="undefined")continue;this.options[t]=e[t]}},this.render=function(e,t,n){typeof t=="function"&&(n=t,t={}),n=n||function(){};var r=new TemplateContext(t);r.load(e,function(t){if(t){n(t);return}try{var i=r.render(e);n(undefined,i)}catch(s){n(s)}})},this.configure(options)};if(typeof module!="undefined"&&module.exports)fs=require("fs"),path=require("path"),CoffeeScript=require("coffee-script"),module.exports=ECT;else{Array.prototype.filter||(Array.prototype.filter=function(e,t){var n=this.length,r=[],i,s;if(typeof e!="function")throw new TypeError;for(i=0;i<n;i++)i in this&&(s=this[i],e.call(t,s,i,this)&&r.push(s));return r}),Array.isArray||(Array.isArray=function(e){return Object.prototype.toString.call(e)==="[object Array]"});var cbSplit;cbSplit||(cbSplit=function(e,t,n){if(Object.prototype.toString.call(t)!=="[object RegExp]")return cbSplit.nativeSplit.call(e,t,n);var r=[],i=0,s=(t.ignoreCase?"i":"")+(t.multiline?"m":"")+(t.sticky?"y":""),o,u,a,f;t=new RegExp(t.source,s+"g"),e+="",cbSplit.compliantExecNpcg||(o=new RegExp("^"+t.source+"$(?!\\s)",s));if(n===undefined||+n<0)n=Infinity;else{n=Math.floor(+n);if(!n)return[]}while(u=t.exec(e)){a=u.index+u[0].length;if(a>i){r.push(e.slice(i,u.index)),!cbSplit.compliantExecNpcg&&u.length>1&&u[0].replace(o,function(){var e;for(e=1;e<arguments.length-2;e++)arguments[e]===undefined&&(u[e]=undefined)}),u.length>1&&u.index<e.length&&Array.prototype.push.apply(r,u.slice(1)),f=u[0].length,i=a;if(r.length>=n)break}t.lastIndex===u.index&&t.lastIndex++}return i===e.length?(f||!t.test(""))&&r.push(""):r.push(e.slice(i)),r.length>n?r.slice(0,n):r},cbSplit.compliantExecNpcg=/()??/.exec("")[1]===undefined,cbSplit.nativeSplit=String.prototype.split),String.prototype.split=function(e,t){return cbSplit(this,e,t)},window.ECT=ECT,CoffeeScript=window.CoffeeScript,path=function(){var e=function(e,t){var n=0,r,i;for(r=e.length-1;r>=0;r--)i=e[r],i==="."?e.splice(r,1):i===".."?(e.splice(r,1),n++):n&&(e.splice(r,1),n--);if(t)while(n)e.unshift(".."),n--;return e},t=function(t){var n=t.charAt(0)==="/",r=t.slice(-1)==="/";return t=e(t.split("/").filter(function(e){return!!e}),!n).join("/"),!t&&!n&&(t="."),t&&r&&(t+="/"),(n?"/":"")+t};return{normalize:t}}();var AjaxObject=function(e,t){var n=this;this.updating=!1,this.abort=function(){n.updating&&(n.updating=!1,n.AJAX.abort(),n.AJAX=null)},this.update=function(){return n.updating?!1:(n.AJAX=null,window.XMLHttpRequest?(n.AJAX=new XMLHttpRequest,n.AJAX.overrideMimeType&&n.AJAX.overrideMimeType("text/html")):n.AJAX=new ActiveXObject("Microsoft.XMLHTTP"),n.AJAX===null?!1:(n.AJAX.onreadystatechange=function(){n.AJAX.readyState===4&&(n.updating=!1,n.callback(n.AJAX.responseText,n.AJAX.status,n.AJAX.responseXML),n.AJAX=null)},n.updating=new Date,n.AJAX.open("GET",e,!0),n.AJAX.send(null),!0))},this.callback=t||function(){}};fs=function(){var e=function(e,t,n){var r=new AjaxObject(e,function(t,r){r<200||r>399?n(new Error("Failed to load template "+e)):n(undefined,t)});try{r.update()}catch(i){n(i)}},t=function(){};return{readFile:e,watch:t}}()}})();